<!DOCTYPE html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8">
		<title>Battle Corruption & Motor User Guide</title>
	</head>
	<style>
		html{font-family:monospace;scroll-behavior:smooth;}
		body{color:#ccc;background-color:#222;padding:4em;max-width:50em;margin:0 auto;}
		h3{color:#4ca;margin:2em 0;}
		p{margin:1em 0;}
		a{color:#ca4;text-decoration:none;}
		a:hover{text-decoration:underline;}
		li a{color:inherit;}
		li{margin:.4em 0;}
		em{color:#0cc;background:#111;font-style:normal;padding:.1em;}
		.contents{color:#c678dd;padding:2em;background:#111;border-radius:.2em;margin:2em 0 1em 0;width:67%;}
		.console{color:#0cc;padding:2em;background:#111;border-radius:.2em;margin:2em 0 1em 0;}
		.nb{padding:2em;font-weight:bold;color:#c24;border-radius:.2em;border:2px solid;margin:2em 0;}
		.c{color:#ccc;}
		.c-keyword{color:#c678dd;}
		.c-operator{color:#c678dd;}
		.c-flow{color:#c678dd;}
		.c-type{color:#54b2bd;}
		.c-comment{color:#666;}
		.c-function{color:#60adec;}
		.c-value{color:#d19a66;}
		.ram{background:#111;border-radius:.2em;padding:1em;}
		.ram-row{margin:.1em;display:flex;}
		.ram-address{margin-right:1em;}
		.ram-bytes{margin:.1em;}
		#backtotop{text-align:right;margin:2em 0;}
	</style>
	<body id="top">
		<h1>Battle Corruption & Motor User Guide</h1>
		<p>Glitch available in Pokémon Diamond, Pearl and Platinum.</p>

		<h3>[Table of Contents]</h3>
		<div class="contents">
			<ul>
				<li><a href="#summary">Glitch summary</a></li>
				<li><a href="#requirements">In-game requirements</a></li>
				<li><a href="#motor">Using Motor</a></li>
				<li><a href="#perform">Performing the Battle Corruption Glitch</a></li>
				<li><a href="#emu">On emulator</a></li>
				<li><a href="#breakdown">Technical breakdown</a></li>
				<li><a href="#end">Closing notes</a></li>
			</ul>
		</div>

		<h3 id="summary">[Glitch summary]</h3>
		<p>Launching a battle with a full party of fainted Pokémon (or eggs) against some static encounters allows you to catch any other Pokémon species.
		This corrupt Pokémon can potentially hold any item, have any ability, know any move, and much more.</p>
		<p>Performing this glitch successfully cannot be done through sheer luck: this is why I created Motor, an application designed to help you find the Pokémon you're looking for.</p>

		<h3 id="requirements">[In-game requirements]</h3>
		<p>In general:</p>
		<ul>
			<li>A Pokémon with Fly/Teleport</li>
			<li>A Master Ball to catch the corrupt wild (the catch rate is botched because of <em>hp_max</em> sometimes being smaller than <em>hp_current</em>, so it is possible to get a 100% catch rate by just throwing a regular Poké Ball but I don't recommend it, and you only get 1 turn to catch the corrupt wild)</li>
		</ul>
		<p>For the RNG manipulation:</p>
		<ul>
			<li>The Coin Flip Poketch App to check your Seed</li>
			<li>A Chatot with a learned saying via Chatter to advance the RNG</li>
			<li>A Pokémon WITHOUT Synchronize or Cute Charm in the first slot of your Party</li>
		</ul>
		<p>Pomeg Glitch (tutorial  <a href="https://youtu.be/ipg3J3COXHQ" target="_blank">here</a>):</p>
		<ul>
			<li>Perform the Pomeg Glitch with a full Party, meaning the last PKMN alive is the one on which the glitch is performed</li>
			<li>Reach your target (Giratina, Arceus, Rotom, etc.) and save in front of it</li>
		</ul>
		<p class="nb">Do not use a Repel once you've done the Pomeg Glitch; you will crash every time you take a step in an area with encounters. Avoid areas with encounters in general, you will also crash if you trigger an encounter.</p>

		<h3 id="motor">[Using Motor]</h3>
		<p>You can download the latest release <a href="https://github.com/MAP233224/Motor/releases/tag/v1.3.5" target="_blank">here.</a></p>
		<p>I am working on creating a cross-platform GUI version of this application, but for now it is only a Windows console application, compiled with GCC. It is written entirely in C, so you can compile it for Mac OS or Linux if you are capable.</p>
		<p>Upon launching the app, you'll be prompted with a set of questions.</p>
		<div class="console">Use saved profile (0=no, 1=yes):</div>
		<p>Type <em>0</em> or <em>1</em> and press ENTER. Choosing 0 (no) will launch the Profile creation prompts. Choosing 1 (yes) will retrieve the User's Profile information in "Profile.txt" if it exists in the same directory as "Motor.exe". If you chose "no" or if "Profile.txt" was not found in the same directory as Motor.exe when chosing "yes", the profile creation prompts will show up.</p>
		<div class="console">Enter your Version (0=Diamond, 1=Pearl, 2=Platinum):</div>
		<p>Which game you're using.</p>
		<div class="console">Enter your Language (1=jp, 2=en, 3=fr, 4=it, 5=ge, 7=sp, 8=ko):</div>
		<p>The language you're playing in: Japanese, English, French, Italian, German, Spanish or Korean.</p>
		<div class="console">Enter your TID (0 to 65535):</div>
		<p>Found on your Trainer Card in game.</p>
		<div class="console">Enter your SID (0 to 65535):</div>
		<p>Found nowhere in game; see the available methods for finding it <a href="https://google.com/" target="_blank">here.</a></p>
		<div class="console">Save those user settings? (0=no, 1=yes)</div>
		<p>A file "Profile.txt" is created in the same directory as "Motor.exe". You can easily edit it or create it yourself.</p>
		<div class="console">Static PKMN you want to corrupt (*):</div>
		<p>The static Pokémon you will corrupt in game. Depends on whether you chose Diamond, Pearl or Platinum. As a side note, Arceus is infinitely re-usable thanks to the numerous infinite Void routes that exist for Diamond and Pearl – I suggest using <a href="https://youtu.be/L7htZgroScI" target="_blank">this RNG friendly route.</a></p>
		<div class="console">ASLR to use (0~11 for jp, 0~4 for ko, 0~3 otherwise):</div>
		<p>Different ASLRs yield different results. Some ASLRs have valid "mirrors", aka they have the same in-game result even if you don't hit the exact ASLR you're looking for. The more mirrors an ASLR has, the more likely you are to get your desired result.</p>
		<p>In Diamond and Pearl:</p>
		<ul>
			<li>ASLR 0, 1, 2, 3 in Japanese all have 4 valid mirrors.</li>
			<li>ASLR 4, 5, 6, 7 in Japanese all have 8 valid mirrors.</li>
			<li>ASLR 8, 9, 10, 11 in Japanese all have 4 valid mirrors.</li>
			<li>ASLR 0 in English, French, Italian, German and Spanish has 1 valid mirror.</li>
			<li>Korean has no mirror ASLR.</li>
		</ul>
		<p>In Platinum:</p>
		<ul>
			<li>ASLR 0 in English has 1 valid mirror.</li>
		</ul>
		<div class="console">Search for a species (0=no, species_id=yes):</div>
		<p>In decimal, the species ID you want to filter for. For example, Mew is <em>151</em>. A list of Pokémon by species ID can be found <a href="http://bulbapedia.bulbagarden.net/wiki/List_of_Pok%C3%A9mon_by_index_number_(Generation_IV)" target="_blank">here.</a></p>
		<div class="console">Search for an item (0=no, item_id=yes):</div>
		<p>Filter for a specific item to be held by the new wild PKMN. A list of items by index number can be found <a href="https://bulbapedia.bulbagarden.net/wiki/List_of_items_by_index_number_(Generation_IV)" target="_blank">here.</a></p>
		<div class="console">Search for a move (0=no, move_id=yes):</div>
		<p>Filter for a specific move known by the new wild PKMN. A list of moves by index number can be found <a href="https://bulbapedia.bulbagarden.net/wiki/List_of_moves" target="_blank">here.</a></p>
		<div class="console">Enter your Seed (32 bit, hex): 0x</div>
		<p>In hexadecimal, the seed of the RNG state. Motor needs a starting point, but it really doesn't matter what it is – I usually pick <em>0</em> when doing full searches.</p>
		<div class="console">How many frames to search through (32 bit, dec):</div>
		<p>In decimal, the number of frames to search through. Pro tip: enter <em>-1</em> to do a full search, as it is more convenient to type than <em>4294967295</em>. You get 1 result every 10 million frames on average.</p>
		<div class="console">Allow more seed options per result? (0=no, 1=yes):</div>
		<p>Allow for duplicate PIDs, which will give you more possible seeds to hit on console for the same PID (aka the same corrupt wild). For convenience and hopefully not having to do too many frame advances in game when RNG manipulating.</p>
		<p>Then the search begins, with a recap of all the parameters you entered. A "Results.txt" file is created in the same directory that "Motor.exe" is in, with a name that matches the original fixed PKMN you're corrupting and your profile info (version_language_tid_sid). Once the search is done, pick a seed that you like and run it through  <a href="https://github.com/MAP233224/ReverseSeed/releases/tag/v1.0" target="_blank">ReverseSeed</a> to get the actual seed you'll need to hit on console via RNG manipulation and the amount of frame advances you'll need to do.</p>
		<div class="nb">
			<ul>
				<li>Platinum is only possible on the Japanese and English version because the Pomeg Glitch was patched in the other international releases.</li>
				<li>Japanese Platinum has a unique crash (when the nickname prompt comes up at the end of the battle) that makes this glitch impossible to fully complete.</li>
				<li>The number of unique results you'll get on a full search without duplicate PIDs is about 400. The more filter you have, the less results you'll get, don't be surprised if you get 0 valid results when filtering by items or moves especially.</li>
				<li>The completion time depends on your CPU, to complete a full search it takes about 30 minutes on a i5-7300HQ, 20 minutes on a i5-11600K as of v1.3.5.</li>
			</ul>
		</div>

		<h3 id="perform">[Performing the Battle Corruption Glitch]</h3>
		<ul>
			<li>Pick a date/time setup (with the help of <a href="https://github.com/Admiral-Fish/PokeFinder/releases" target="_blank">PokéFinder</a>) for the seed given by ReverseSeed.</li>
			<li>Important: when launching the game for the RNG manipulation (white loading screen), don't fiddle with the microphone, the touch screen or the buttons; it'll make the ASLR inconsistent.</li>
			<li>If you hit the correct seed and do the correct amount of frame advances with Chatot but don't get your result in battle, it means you got the wrong ASLR, so you need to use a different date/time setup. Pro tip: usually you can just pick a time with one minute prior and one second later, or vice-versa, the seed will be the same. You can verify this with Pokéfinder if you're unsure.</li>
			<li>If you get the correct Pokémon to show up (congrats!), go straight to BAG > POKé BALLS > Master Ball. Watching the Moves or Party will crash.</li>
			<li>Once caught, give it a nickname to set a terminator character in its name and make it valid.</li>
		</ul>
		<p class="nb">The most common failure points are: infinite black loading screen, crash before battle menu, crash when resuming to the overworld, any status update on turn 0 that transforms the corrupt wild into a Bad Egg and crashes on dex entry.</p>
		<p>Side effects:</p>
		<ul>
			<li>The corrupt wild's data is essentially random which means several things: you have a 1 in 2 chance to get the Fateful Encounter flag on it, meaning you could get a Shaymin in Platinum with it and get the Gracidea in Floaroma and use it to get Sky Form Shaymin. You also have a 7 in 8 (?) chance of getting Pokérus, and a 1 in 2 chance of it being an Egg. Being an Egg offers several things: you can hatch it (random Egg cycle, maximum of 255 which is 65,280 steps without any special date or Flame Body bonus)</li>
			<li>The Pokémon you'll catch will be permanently decrypted</li>
			<li>You cannot trade it, unless it was Egg and you hatched it and got rid of its glitch moves in the Day-Care</li>
			<li></li>
		</ul>

		<h3 id="emu">[On emulator]</h3>
		<p>Along with Motor's executable, you can download "Motor.lua" which contains several useful functions allowing you to perform the Battle Corruption Glitch a lot more reliably in the <a href="http://desmume.org/download" target="_blank">Desmume</a> emulator, version 0.9.11.</p>
		<p>Functions included in "Motor.lua":</p>
		<ul>
			<li>Searching for a specific ASLR</li>
			<li>Getting a full fainted team instantaneously</li>
			<li>Setting your TID and SID to any value</li>
			<li>Seeing the raw data of your 7th Pokémon and the corrupt wild Pokémon</li>
			<li>Decrypting the data of any wild Pokémon</li>
			<li>Setting the RNG to any state, as well as advancing/backtracking it</li>
		</ul>
		<p>I am working on writting proper documentation for this LUA script. For now, looking at the code should be sufficient.</p>

		<h3 id="breakdown">[Technical breakdown]</h3>
		<p>//If you want to know more :)</p>
		<p>The data of the corrupt wild Pokémon is influenced by several factors:</p>
		<ul>
			<li>ASLR</li>
			<li>TID and SID (internally, it's the same 32-bit value, you just see the lower 16-bit on your Trainer Card)</li>
			<li>Version and Language</li>
			<li>The current state of the RNG</li>
			<li>The original Wild Pokémon</li>
		</ul>
		<p>A Pokémon's data structure:</p>
		<ul>
			<li>8 bytes of unencrypted data (4 bytes for the PID, 2 bytes for the Checksum, 1 bit for the Bad Egg flag, 2 bits for the Checksum Skipped "fast mode" flags and 13 unused bits)</li>
			<li>128 bytes of "ABCD" Block data (32 bytes x4), encrypted with the Checksum</li>
			<li>100 bytes of Condition/Battle data, encrypted with the PID</li>
		</ul>
		<p>"What is ASLR?" ASLR stands for <a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization" target="_blank">Address Space Layout Randomization.</a> In our case, it means that RAM is shifted into one of 65 different positions by 4 bytes (because the DS operates on a 32-bit CPU) every time the game is initialized. It is pseudo-randomly determined by your MAC address, your ABXY buttons, microphone and touch screen inputs in the white loading screen before the copyrights for Pokémon, Nintendo, Creatures Inc. and GAME FREAK inc. show up. It plays a role in the corrupt wild's data simply because the 7th Pokémon that gets created overwrites the header of the Opponent 1 Party structure, which includes a pointer to the previous Party block (the Player's Party) and a pointer to the next Party structure (the Ally's Party). Pointers are 32-bit values that hold memory addresses, and in this section of memory, addresses depend on ASLR.</p>
		<p>You TID and SID are assigned to any regular wild Pokémon when it is generated, this is why knowing them is important to know what you're going to get when it gets corrupted. They are store in Block A.</p>
		<p>It's the same thing for Version (stored in Block C) and Language (stored in Block A).</p>
		<p>A series of fortunate events:</p>
		<ul>
			<li>The original wild Pokémon is generated with standard PRNG Method J (for static Pokémon)</li>
			<li>A 7th Pokémon is "created" in the Player's Party, it inherits part of the original wild's data because of the stack overflow caused by its size and the immediate proximity of the Party structures</li>
			<li>The Checksum of the Player's 7th Pokémon doesn't match its data, so its Bad Egg flag is turned on (this is why you always send out a Bad Egg when performing the glitch)</li>
			<li>Its data is encrypted according to its current Checksum (0x0000)</li>

			<li>Its data is re-encrypted according to its new calculated Checksum (sum of all the 16-bit words in its ABCD block data) and its PID (always equal to 0x00005544 because it's the header identifier of all data structures in the game) for Condition data</li>
		</ul>
		Dead full party, Seventh pkmn, Bad Egg flag, encrypt, stack overflow, corrupt wild, encrypt, checksum check, encrypt.
		<p>Hurdles (failure points): Bad Egg, Checksum check skipped, glitchmons, glitchballs, first move of Seven, ...</p>
		<p>Effects: permanently decrypted, ...</p>
		<p>Read the code in Motor.c if you want to know more!</p>
		<p>The original overflow ("creating" a 7th Pokémon):</p>
		<p>Simplified version of the function "FightSystemBoot" in "fight.c" from the Diamond and Pearl source code.</p>
		<div class="console c">
			<span class="c-keyword">for</span> ( <span class="c-type">int</span> i <span class="c-operator">=</span> <span class="c-value">0</span>; i <span class="c-operator"><</span> partySize; i<span class="c-operator">++</span> ) {<br>
				<span class="c-keyword">&emsp;&emsp;if </span>( <span class="c-function">PkmnGet</span>(species) <span class="c-operator">&&</span> (<span class="c-function">PkmnGet</span>(egg_flag) <span class="c-operator">==</span> <span class="c-value">0</span>) <span class="c-operator">&&</span><span class="c-function">PkmnGet</span>(hp) ) {<br>&emsp;&emsp;&emsp;&emsp;<span class="c-flow">break</span>;<br>&emsp;&emsp;}<br>
			}<br>
			<span class="c-function">ServerDataPut</span>(sent_out_pkmn, i);<br><br>
			<span class="c-comment">// partySize is 6 in our case. If species ID is non-zero AND is not an Egg AND HP is non-zero, break out of the loop. Since all of our Pokémon are either fainted or Egg, we never break out of this loop and exit with i equal to 6, which corresponds to a 7th index position. ServerDataPut() stores the index of the Pokémon being sent out, which in turn "creates" space for a 7th Pokémon in the Player's Party.</span>
		</div>
		<p>Memory Viewer</p>
		<div class="ram">
			<div class="ram-row">
				<div class="ram-address">Address&emsp;&emsp;&emsp;&emsp;|</div>
				<div class="ram-bytes">00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F</div>
			</div>
			<div class="ram-row">
				<div class="ram-bytes">-------------------------------------------------------------</div>
			</div>
			<div class="ram-row">
				<div class="ram-address">0x02000000 |</div>
				<div class="ram-bytes">44 55 00 00 aa aa aa aa aa aa aa aa aa aa aa aa</div>
			</div>
			<div class="ram-row">
				<div class="ram-address">0x02000010 |</div>
				<div class="ram-bytes">44 55 00 00 aa aa aa aa aa aa aa aa aa aa aa aa</div>
			</div>
			<div class="ram-row">
				<div class="ram-address">0x02000020 |</div>
				<div class="ram-bytes">44 55 00 00 aa aa aa aa aa aa aa aa aa aa aa aa</div>
			</div>
			<div class="ram-row">
				<div class="ram-address">0x02000030 |</div>
				<div class="ram-bytes">44 55 00 00 aa aa aa aa aa aa aa aa aa aa aa aa</div>
			</div>
			<div class="ram-row">
				<div class="ram-address">0x02000040 |</div>
				<div class="ram-bytes">44 55 00 00 aa aa aa aa aa aa aa aa aa aa aa aa</div>
			</div>
			<div class="ram-row">
				<div class="ram-address">0x02000050 |</div>
				<div class="ram-bytes">44 55 00 00 aa aa aa aa aa aa aa aa aa aa aa aa</div>
			</div>
			<div class="ram-row">
				<div class="ram-address">0x02000060 |</div>
				<div class="ram-bytes">44 55 00 00 aa aa aa aa aa aa aa aa aa aa aa aa</div>
			</div>
			<div class="ram-row">
				<div class="ram-address">0x02000070 |</div>
				<div class="ram-bytes">44 55 00 00 aa aa aa aa aa aa aa aa aa aa aa aa</div>
			</div>
			<div class="ram-row">
				<div class="ram-address">0x02000080 |</div>
				<div class="ram-bytes">44 55 00 00 aa aa aa aa aa aa aa aa aa aa aa aa</div>
			</div>
			<div class="ram-row">
				<div class="ram-address">0x02000090 |</div>
				<div class="ram-bytes">44 55 00 00 aa aa aa aa aa aa aa aa aa aa aa aa</div>
			</div>
			<div class="ram-row">
				<div class="ram-address">0x020000A0 |</div>
				<div class="ram-bytes">44 55 00 00 aa aa aa aa aa aa aa aa aa aa aa aa</div>
			</div>
			<div class="ram-row">
				<div class="ram-address">0x020000B0 |</div>
				<div class="ram-bytes">44 55 00 00 aa aa aa aa aa aa aa aa aa aa aa aa</div>
			</div>
			<div class="ram-row">
				<div class="ram-address">0x020000C0 |</div>
				<div class="ram-bytes">44 55 00 00 aa aa aa aa aa aa aa aa aa aa aa aa</div>
			</div>
			<div class="ram-row">
				<div class="ram-address">0x020000D0 |</div>
				<div class="ram-bytes">44 55 00 00 aa aa aa aa aa aa aa aa aa aa aa aa</div>
			</div>
			<div class="ram-row">
				<div class="ram-address">0x020000E0 |</div>
				<div class="ram-bytes">44 55 00 00 aa aa aa aa aa aa aa aa aa aa aa aa</div>
			</div>
			<div class="ram-row">
				<div class="ram-address">0x020000F0 |</div>
				<div class="ram-bytes">44 55 00 00 aa aa aa aa aa aa aa aa aa aa aa aa</div>
			</div>
		</div>

		<h3 id="end">[Closing notes]</h3>
		<p>A little bit of history.</p>
		<p>I've been researching this glitch since March 2020, and started to work on Motor in November 2020. I finished writting this page in December 2021, but really the bulk of what was needed in Motor was completed in November 2021.</p>
		<p>At first I was trying things out in Python, but seeing the performance increase that C gave was just too good to ignore. Plus, the source code for Diamond and Pearl leaked in May 2020 and seeing that they were also programmed in C piqued my interest, so I decided to learn the language.</p>
		<p>This is the <a href="https://youtu.be/Cidiu16C_Bk" target="_blank">original Proof of Concept video</a> – I didn't understand what exactly was happening but the data looked completely random, so I thought to myself "Maybe I could get a valid species with this". I then just started resetting randomly until I found something interesting, and this Meditite is the first instance of this.</p>
		<p>What I do not know yet:</p>
		<ul>
			<li>Why you sometimes crash when returning to the overworld once the battle is over</li>
			<li>Why Drifloon doesn't work (overworld crash)</li>
			<li>Why regular encounters do not work (overworld crash)</li>
			<li>Why double encounters sometimes work</li>
			<li>If there is a way to get a full fainted Party in Pokémon Heart Gold and Soul Silver</li>
		</ul>
		<p id="backtotop"><a href="#top">Back to top.</a></p>

	</body>
</html>
